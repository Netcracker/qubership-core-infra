name: Create Branches from Release Summary

on:
  workflow_dispatch:
    inputs:
      branch_name:
        description: 'New branch name to create (e.g., lts/1.7.x)'
        required: true
        type: string
      summary_content:
        description: 'Paste the RAW release job summary content here'
        required: true
        type: string
      dry_run:
        description: 'Dry run (preview only, do not create branches)'
        required: false
        type: boolean
        default: true
  workflow_call:
    inputs:
      branch_name: { required: true, type: string }
      summary_content: { required: true, type: string }
      dry_run: { required: false, type: boolean, default: false }

jobs:
  parse-summary:
    runs-on: ubuntu-latest
    outputs:
      repos_and_tags: ${{ steps.parse.outputs.repos_and_tags }}

    steps:
      - name: Validate branch name
        run: |
          BRANCH="${{ inputs.branch_name }}"
          
          if [[ ! "$BRANCH" =~ ^[a-zA-Z0-9/_.-]+$ ]]; then
            echo "::error title=Invalid Branch Name::Branch name '$BRANCH' contains invalid characters"
            exit 1
          fi
          
          echo "âœ“ Branch name validated: $BRANCH"

      - name: Parse summary
        id: parse
        shell: bash
        run: |
          set -euo pipefail

          cat <<'EOF' > summary.md
          ${{ inputs.summary_content }}
          EOF

          echo "Summary content received"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          nl -ba summary.md
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # 1. Extract repo from GitHub URL
          repo_regex='\(https://github\.com/([^/]+/[^/\)]+)'
          repo=""

          # 2. Extract version from FIRST artifact line only
          version=""

          while IFS= read -r line; do
            # Repo (first match wins)
            if [[ -z "$repo" && $line =~ $repo_regex ]]; then
              repo="${BASH_REMATCH[1]}"
              echo "Found repository: $repo"
            fi

            # Version from first artifact line
            if [[ -z "$version" && $line =~ ^[^:]+:[^:]+:([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
              version="${BASH_REMATCH[1]}"
              echo "Found version (from first artifact): $version"
            fi
          done < summary.md

          if [[ -z "$repo" || -z "$version" ]]; then
            echo "::error title=Parsing Failed::Could not extract repo or version"
            exit 1
          fi

          repos_and_tags="["
          repos_and_tags+="{\"repo\":\"$repo\",\"tag\":\"$version\"}"
          repos_and_tags+="]"

          echo "repos_and_tags=$repos_and_tags" >> "$GITHUB_OUTPUT"

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Parsed repositories and tags:"
          echo "$repos_and_tags" | jq '.'
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  create-branches:
    needs: parse-summary
    runs-on: ubuntu-latest
    strategy:
      matrix:
        item: ${{ fromJSON(needs.parse-summary.outputs.repos_and_tags) }}
      fail-fast: false
      max-parallel: 5

    steps:
      - name: Create branch from tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: ${{ inputs.branch_name }}
          REPO: ${{ matrix.item.repo }}
          TAG: ${{ matrix.item.tag }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          if [ "$DRY_RUN" = "true" ]; then
            echo "ğŸ” DRY RUN MODE - No branches will be created"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Repository: $REPO"
          echo "Creating branch: $BRANCH from tag: $TAG"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Check if tag exists (try both with and without 'v' prefix)
          TAG_SHA=""
          
          # Try with the tag as-is
          if gh api repos/$REPO/git/refs/tags/$TAG &>/dev/null; then
            TAG_SHA=$(gh api repos/$REPO/git/refs/tags/$TAG --jq '.object.sha')
          # Try with 'v' prefix
          elif gh api repos/$REPO/git/refs/tags/v$TAG &>/dev/null; then
            TAG_SHA=$(gh api repos/$REPO/git/refs/tags/v$TAG --jq '.object.sha')
            TAG="v$TAG"
          else
            echo "::warning title=Tag Not Found::Tag '$TAG' (or 'v$TAG') does not exist in $REPO"
            exit 0
          fi
          
          echo "Found tag: $TAG"
          echo "Tag SHA: $TAG_SHA"
          
          # Check if branch already exists
          if gh api repos/$REPO/git/refs/heads/$BRANCH &>/dev/null; then
            EXISTING_SHA=$(gh api repos/$REPO/git/refs/heads/$BRANCH --jq '.object.sha')
            if [ "$EXISTING_SHA" = "$TAG_SHA" ]; then
              echo "::notice title=Branch Up-to-Date::Branch '$BRANCH' already exists and points to the same commit in $REPO"
            else
              echo "::warning title=Branch Exists::Branch '$BRANCH' already exists but points to a different commit in $REPO"
            fi
            exit 0
          fi
          
          # Create the branch (or simulate in dry run mode)
          if [ "$DRY_RUN" = "true" ]; then
            echo "::notice title=Dry Run::Would create branch '$BRANCH' from tag '$TAG' in $REPO"
            echo "âœ“ [DRY RUN] Branch would be created successfully"
            echo "  URL: https://github.com/$REPO/tree/$BRANCH"
          else
            gh api repos/$REPO/git/refs \
              -X POST \
              -f ref="refs/heads/$BRANCH" \
              -f sha="$TAG_SHA"
          
            if [ $? -eq 0 ]; then
              echo "::notice title=Branch Created::Successfully created branch '$BRANCH' from tag '$TAG' in $REPO"
              echo "âœ“ Branch created successfully"
              echo "  URL: https://github.com/$REPO/tree/$BRANCH"
            else
              echo "::error title=Branch Creation Failed::Failed to create branch '$BRANCH' in $REPO"
              exit 1
            fi
          fi

  branch-report:
    needs: [ parse-summary, create-branches ]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Generate summary
        env:
          REPOS_AND_TAGS: ${{ needs.parse-summary.outputs.repos_and_tags }}
        run: |
          DRY_RUN_LABEL=""
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            DRY_RUN_LABEL=" [DRY RUN]"
          fi
          
          echo "## Branch Creation Summary${DRY_RUN_LABEL}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "> **ğŸ” DRY RUN MODE** - No branches were actually created. This is a preview only." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "- **Branch Name:** \`${{ inputs.branch_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run:** ${{ inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ needs.create-branches.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Repositories and Tags" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Create a table
          echo "| Repository | Tag | LTS Branch URL |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|-----|----------------|" >> $GITHUB_STEP_SUMMARY
          
          echo "$REPOS_AND_TAGS" | jq -r '.[] | "| \(.repo) | \(.tag) | https://github.com/\(.repo)/tree/${{ inputs.branch_name }} |"' >> $GITHUB_STEP_SUMMARY