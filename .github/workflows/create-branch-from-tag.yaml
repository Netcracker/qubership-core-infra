name: Create Branches from Release Summary

on:
  workflow_dispatch:
    inputs:
      branch_name:
        description: 'New branch name to create (e.g., lts/1.7.x)'
        required: true
        type: string
      summary_content:
        description: 'Paste the RAW release job summary content here'
        required: true
        type: string
      dry_run:
        description: 'Dry run (preview only, do not create branches)'
        required: false
        type: boolean
        default: true
  workflow_call:
    inputs:
      branch_name: { required: true, type: string }
      summary_content: { required: true, type: string }
      dry_run: { required: false, type: boolean, default: false }

permissions:
  contents: write

jobs:
  parse-summary:
    runs-on: ubuntu-latest
    outputs:
      repos_and_tags: ${{ steps.parse.outputs.repos_and_tags }}

    steps:
#      - name: Validate branch name
#        run: |
#          BRANCH="${{ inputs.branch_name }}"
#
#          if [[ ! "$BRANCH" =~ ^[a-zA-Z0-9/_.-]+$ ]]; then
#            echo "::error title=Invalid Branch Name::Branch name '$BRANCH' contains invalid characters"
#            exit 1
#          fi
#
#          echo "âœ“ Branch name validated: $BRANCH"

      - name: Parse release summary
        id: parse
        shell: bash
        run: |
          set -euo pipefail
          
          # Write pasted summary content
          cat <<'EOF' > summary.md
          ${{ inputs.summary_content }}
          EOF
          
          sed -i -E '
            s/\r$//;
            s/^[[:space:]]+//;
            s/```[[:space:]]*/\n```\n/g;
            s/[[:space:]]*```/\n```\n/g;
            s/([0-9]+\.[0-9]+\.[0-9]+)/\1\n/g
          ' summary.md
          
          echo "Summary content received (normalized)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          nl -ba summary.md
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          repo_regex='\(https://github\.com/([^/]+/[^/\)]+)\)'
          version_regex='^[^:]+:[^:]+:([0-9]+\.[0-9]+\.[0-9]+)'
          
          repos_and_tags="["
          first_entry=true
          
          current_repo=""
          expecting_version=false
          
          while IFS= read -r line; do
            # Detect repo header
            if [[ $line =~ $repo_regex ]]; then
              current_repo="${BASH_REMATCH[1]}"
              expecting_version=true
              echo "Found repository: $current_repo"
              continue
            fi
          
            # First artifact line after repo header
            if [[ "$expecting_version" = true && $line =~ $version_regex ]]; then
              version="${BASH_REMATCH[1]}"
              echo "  Found version: $version"
          
              if [ "$first_entry" = true ]; then
                first_entry=false
              else
                repos_and_tags+=","
              fi
          
              repos_and_tags+="{\"repo\":\"$current_repo\",\"tag\":\"$version\"}"
          
              # Reset for next repo
              expecting_version=false
              current_repo=""
            fi
          done < summary.md
          
          repos_and_tags+="]"
          
          if [ "$repos_and_tags" = "[]" ]; then
            echo "::error title=Parsing Failed::No repositories were parsed"
            exit 1
          fi
          
          echo "repos_and_tags=$repos_and_tags" >> "$GITHUB_OUTPUT"
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Parsed repositories and tags:"
          echo "$repos_and_tags" | jq '.'
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  create-branches:
    if: ${{ !inputs.dry_run }}
    needs: parse-summary
    runs-on: ubuntu-latest
    strategy:
      matrix:
        item: ${{ fromJSON(needs.parse-summary.outputs.repos_and_tags) }}
      fail-fast: false
      max-parallel: 5

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          token: '${{ secrets.GH_ACCESS_TOKEN }}'
          repository: ${{ matrix.item.repo }}
          ref: ${{ matrix.item.tag }}

      - name: Create branch
        uses: netcracker/qubership-workflow-hub/actions/branch-action@v2.0.10
        with:
          source-ref: ${{ matrix.item.tag }}
          branch-name: ${{ inputs.branch_name }}
          dry-run: ${{ inputs.dry_run }}

  branch-report:
    needs: [ parse-summary, create-branches ]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Generate summary
        env:
          REPOS_AND_TAGS: ${{ needs.parse-summary.outputs.repos_and_tags }}
        run: |
          DRY_RUN_LABEL=""
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            DRY_RUN_LABEL=" [DRY RUN]"
          fi
          
          echo "## Branch Creation Summary${DRY_RUN_LABEL}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "> **ğŸ” DRY RUN MODE** - No branches were actually created. This is a preview only." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "- **Branch Name:** \`${{ inputs.branch_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run:** ${{ inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ needs.create-branches.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Repositories and Tags" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Create a table
          echo "| Repository | Tag | LTS Branch URL |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|-----|----------------|" >> $GITHUB_STEP_SUMMARY
          
          echo "$REPOS_AND_TAGS" | jq -r '.[] | "| \(.repo) | \(.tag) | https://github.com/\(.repo)/tree/${{ inputs.branch_name }} |"' >> $GITHUB_STEP_SUMMARY