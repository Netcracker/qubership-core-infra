# $schema: https://raw.githubusercontent.com/SchemaStore/schemastore/refs/heads/master/src/schemas/json/github-workflow.json

name: "Maven bulk release of core services[branch aware]"
run-name: Maven bulk release of core-services [${{ inputs.repositoryToRelease }}] [dry-run:${{ inputs.dryRun }}] by @${{ github.actor }}'

on:
  workflow_dispatch:
    inputs:
      repositoryToRelease:
        type: choice
        description: "Repository to bulk release from. Select 'all' to release all repositories"
        options:
          - all
          - qubership-core-config-server
          - qubership-core-core-operator
      gavs:
        type: string
        description: "Comma separated list of GAV(s)"
        default: ""
      versionIncrementType:
        description: "Version part to increment"
        type: choice
        options:
          - patch
          - minor
          - major
        default: patch
      lts_branch_name:
        description: "LTS branch name to create (e.g., lts/1.7.x) - only when running from main"
        type: string
        required: false
        default: ""
      skipTest:
        description: "skip tests"
        type: boolean
        default: false
      dryRun:
        description: "dry run"
        type: boolean
        default: true
      logsToConsole:
        description: "log to console"
        type: boolean
        default: false

concurrency:
  group: "core-libs"
  cancel-in-progress: false

permissions:
  actions: write
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest
    env:
      MAVEN_USER: "x-access-token"
      MAVEN_TOKEN: ${{ secrets.MAVEN_RELEASE_DEV_TOKEN }}
      MAVEN_GPG_PASSPHRASE: ${{ secrets.maven-gpg-passphrase }}
    outputs:
      result: ${{ steps.run-maven-bulk-release-cli.outputs.result }}
      summary_content: ${{ steps.save-summary.outputs.content }}

    steps:
      - name: Validate branch name
        if: github.ref_name != 'main' && !startsWith(github.ref_name, 'lts/')
        run: |
          echo "::error title=Invalid Branch::Branch '${{ github.ref_name }}' is not allowed. Only 'main' or branches starting with 'lts/' are permitted."
          echo "Error: Invalid branch '${{ github.ref_name }}'"
          echo "Only 'main' or branches starting with 'lts/' are allowed"
          exit 1

      - name: Validate LTS branch version increment
        if: startsWith(github.ref_name, 'lts/') && inputs.versionIncrementType != 'patch'
        run: |
          echo "::error title=Invalid Version Increment::LTS branches can only increment PATCH version. Selected: '${{ inputs.versionIncrementType }}'"
          echo "Current branch: ${{ github.ref_name }}"
          echo "Selected increment: ${{ inputs.versionIncrementType }}"
          echo "LTS branches can only increment PATCH version"
          exit 1

      - name: "Checkout"
        uses: actions/checkout@v6
        with:
          ref: "main"
          token: '${{ secrets.MAVEN_RELEASE_DEV_TOKEN }}'

      - name: "Download GAVs from another release workflow(s)"
        id: download-gavs
        if: ${{ inputs.runIdsWithGAVs != '' || inputs.gavs != '' }}
        shell: bash
        env:
          RUN_IDS: ${{ inputs.runIdsWithGAVs }}
          INPUT_GAVS: ${{ inputs.gavs }}
        # language="shell script"
        run: |-
          GAVS="${INPUT_GAVS}"
          IFS=','
          for runId in ${RUN_IDS}; do
            url="https://api.github.com/repos/Netcracker/qubership-core-infra/actions/runs/${runId}/artifacts"
            gavsFile="gavs.txt"
            zipUrl=$(curl -s -L -H "Authorization: Bearer ${MAVEN_TOKEN}" "${url}" | jq -r --arg name "${gavsFile}" '.artifacts[] | select(.name == $name) | .archive_download_url')
            if [ -s "${zipUrl}" ]; then
              echo "artifacts from ${url} do not contain ${gavsFile} artifact"
              exit 1
            fi
            dir="/tmp/gavs_artifacts/${runId}"
          
            mkdir -p "${dir}"
          
            zipFile="${dir}/gavs.zip"
            echo "Downloading ${gavsFile} from ${zipUrl}"
            curl -o "${zipFile}" -L -H "Authorization: Bearer ${MAVEN_TOKEN}" "${zipUrl}" || { echo "Failed to download ${gavsFile}"; exit 1; }
          
            echo "Extracting ${zipFile} to ${dir}"
            unzip -o "${zipFile}" -d "${dir}" || { echo "Failed to extract ${zipFile}"; exit 1; }
          
            extractedGAVsFile="${dir}/${gavsFile}"
            if [ -e "${extractedGAVsFile}" ]; then
              gavs=$(cat "${extractedGAVsFile}" | tr '\n' ',')
              if [ -n "${GAVS}" ]; then
                 GAVS="${GAVS},${gavs}"
              else
                 GAVS="${gavs}"
              fi
            else
              echo "File ${extractedGAVsFile} not found"
              exit 1
            fi
          done
          echo "gavs=${GAVS}" >> "${GITHUB_OUTPUT}"

      - name: "Read repositories"
        id: read-repositories
        shell: bash
        env:
          BRANCH_NAME: ${{ github.ref_name }}
        # language="shell script"
        run: |
          repositories="https://github.com/Netcracker/qubership-core-config-server[branch=${BRANCH_NAME}]
          https://github.com/Netcracker/qubership-core-core-operator[branch=${BRANCH_NAME}]"
          echo "repositories=\n${repositories}"
          repositories=$(echo "${repositories}" | tr '\n' ',')
          echo "repositories=${repositories}" >> "${GITHUB_OUTPUT}"

      - name: "Cache Maven dependencies"
        uses: actions/cache@v5
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ github.run_id }}
          restore-keys: ${{ runner.os }}-maven-

      - name: "Set up java"
        uses: actions/setup-java@v5
        with:
          java-version: |
            17
            21
          architecture: 'x64'
          distribution: 'temurin'
          server-id: github
          server-username: MAVEN_USER
          server-password: MAVEN_TOKEN
          gpg-private-key: ${{ inputs.maven-gpg-private-key }}
          gpg-passphrase: MAVEN_GPG_PASSPHRASE

      - name: "Run maven-bulk-release-cli"
        id: run-maven-bulk-release-cli
        shell: bash
        env:
          GAVS: ${{ steps.download-gavs.outputs.gavs }}
          REPOSITORIES: ${{ steps.read-repositories.outputs.repositories }}
          REPOSITORY_TO_RELEASE_FROM: ${{ inputs.repositoryToRelease }}
          VERSION_INCREMENT_TYPE: ${{ inputs.versionIncrementType }}
          SKIP_TEST: ${{ inputs.skipTest }}
          DRY_RUN: ${{ inputs.dryRun }}
          LOG_TO_CONSOLE: ${{ inputs.logsToConsole }}
        # language="shell script"
        run: |
          #          cli_name="maven-bulk-release-cli"
          #          cli_version="1.5.0-SNAPSHOT"
          #          
          #          mvn org.apache.maven.plugins:maven-dependency-plugin:3.9.0:copy \
          #          -DremoteRepositories="github::default::https://maven.pkg.github.com/netcracker" \
          #          -Dartifact="org.qubership.cloud:${cli_name}:${cli_version}:jar:jar-with-dependencies" \
          #          -DoutputDirectory="/tmp" -U -X
          #          
          #          cli_jar=$(ls -1 "/tmp" | grep "${cli_name}" | tr -d '\n')
          #                    
          cliVersion="1.5.0-SNAPSHOT"   
          cliVersionSpecific="1.5.0-20251105.133058-37"
          url="https://maven.pkg.github.com/Netcracker/qubership-core-infra/org.qubership.cloud/maven-bulk-release-cli/${cliVersion}/maven-bulk-release-cli-${cliVersionSpecific}-jar-with-dependencies.jar"
          curl -L -o "maven-bulk-release-cli.jar" -H "Authorization: Bearer ${MAVEN_TOKEN}" "${url}"
          cli_jar="maven-bulk-release-cli.jar"
                    
          options=""
          if [ "${SKIP_TEST}" = "true" ]; then
            options="${options} --skipTests"
          fi
          if [ "${DRY_RUN}" = "true" ]; then
            options="${options} --dryRun"
          fi
          if [ "${LOG_TO_CONSOLE}" = "true" ]; then
            options="${options} --logsToConsole"
          fi
          
          repositoriesToReleaseFrom=""
          if [ "${REPOSITORY_TO_RELEASE_FROM}" != "all" ]; then
            repositoriesToReleaseFrom=$(echo "${REPOSITORIES}" | tr ',' '\n' | grep "${REPOSITORY_TO_RELEASE_FROM}")
          fi
          args="--baseDir=/tmp"
          args="${args} --gitURL=https://github.com"
          args="${args} --gitUsername=actions"
          args="${args} --gitEmail=actions@github.com"
          args="${args} --gitPassword=${MAVEN_TOKEN}"
          args="${args} --mavenDeployArtifacts=true"
          args="${args} --runParallelism=2"
          args="${args} --repositories=${REPOSITORIES}"
          args="${args} \"--repositoriesToReleaseFrom=${repositoriesToReleaseFrom}\""
          args="${args} --gavs=${GAVS}"
          args="${args} --versionIncrementType=${VERSION_INCREMENT_TYPE}"
          args="${args} --javaVersionToJavaHomeEnv=17=${JAVA_HOME_17_X64},21=${JAVA_HOME_21_X64}"
          args="${args} --resultOutputFile=${GITHUB_OUTPUT}"
          args="${args} --summaryFile=${GITHUB_STEP_SUMMARY}"
          args="${args} --gavsResultFile=/tmp/gavs.txt"
          args="${args} --dependencyGraphFile=/tmp/graph.dot"
          args="${args} ${options}"
          cmd="java -jar ${cli_jar} ${args}"
          echo "running cmd: ${cmd}"
          eval "${cmd}"
          
          cp "${GITHUB_STEP_SUMMARY}" /tmp/summary.md

      - name: "Upload gavs artifact"
        uses: actions/upload-artifact@v6
        with:
          name: gavs.txt
          path: /tmp/gavs.txt

      - name: "Upload graph artifact"
        uses: actions/upload-artifact@v6
        with:
          name: graph.dot
          path: /tmp/graph.dot

      - name: "Upload logs artifact"
        if: ${{ always() }}
        uses: actions/upload-artifact@v6
        with:
          name: logs
          path: /tmp/logs/

      - name: Save summary content
        id: save-summary
        run: |
          # Read the summary content and encode it for output
          summary_content=$(cat /tmp/summary.md)
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$summary_content" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  create-branches:
    needs: release
    if: |
      github.ref_name == 'main' && 
      inputs.lts_branch_name != '' && 
      startsWith(inputs.lts_branch_name, 'lts/')
    uses: ./.github/workflows/create-branch-from-tag.yaml
    with:
      branch_name: ${{ inputs.lts_branch_name }}
      summary_content: ${{ needs.release.outputs.summary_content }}
      dry_run: ${{ inputs.dryRun }}
